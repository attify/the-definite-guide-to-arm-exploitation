//brutecanary.c
#include <stdio.h>
#include <unistd.h>
#include <sys/types.h> 
#include <sys/socket.h> 
#include <netinet/in.h>

int newsockfd;
char msg1[] = "Enter something to echo:\n";

/*
Echoes back a single message
*/
void do_echo()
{
    send(newsockfd, msg1, sizeof(msg1), 0);
    
    char buffer[20];
    size_t nRead;
    
    nRead = recv(newsockfd, buffer, 100, 0);
    send(newsockfd, buffer, nRead, 0);
}


/*
Calls do_echo in an infinte loop
*/
void do_loop()
{
    while (1)
    {
        do_echo();
    }
}


/*
Call this function for a win
*/
void win()
{
    // Duplicate stdin, stdout, stderr
    dup2(newsockfd, STDIN_FILENO);
    dup2(newsockfd, STDOUT_FILENO);
    dup2(newsockfd, STDERR_FILENO);
    
    puts("You won, enjoy your shell");
    system("/bin/sh");
}


/*
The main function
*/
int main()
{
    int sockfd, cli_len;
    uint16_t port = 1337;
    struct sockaddr_in serv_addr;
    struct sockaddr_in client_addr;
    
    cli_len = sizeof(client_addr);
    sockfd = socket(AF_INET, SOCK_STREAM, 0);
    
    serv_addr.sin_family = AF_INET;
    serv_addr.sin_port = htons(port);
    serv_addr.sin_addr.s_addr = htonl(INADDR_ANY);
    
    if (bind(sockfd, (struct sockaddr *) &serv_addr, sizeof(serv_addr)) < 0)
    {
        perror("[!] Bind failed");
        return -1;
    }
    
    puts("[+] Echo service running on port 1337");
    
    if (listen(sockfd, SOMAXCONN) < 0) 
    {
        perror("[!] Listen failed");
        return -1;
    }
    
    while (1)
    {
        newsockfd = accept(sockfd, (struct sockaddr *) &client_addr,  (socklen_t *) &cli_len);
        if (newsockfd < 0) 
        {
            perror("[!] Error on accept");
            return -1;
        }
            
        else
        {
            puts("[+] Connection accepted");
            // Fork for every new connection
            if (fork() == 0)
            {
                // Inside child, Never returns
                do_loop(); 
            }
            // In parent
            close(newsockfd);
        }
    }
    return 0;
}