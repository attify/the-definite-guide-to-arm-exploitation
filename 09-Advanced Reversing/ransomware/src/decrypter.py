#!/usr/bin/env python

"""
Decrypts file encrypted by the ransomware
"""

import argparse
from struct import unpack

from Crypto.Cipher import ARC4
from Crypto.PublicKey import RSA
from Crypto.Cipher import PKCS1_v1_5


def main(efile, dfile, keyfile):
    if efile.read(8) != '_crypted':
        efile.close()
        print 'Not an encrypted file'
        return

    # RSA encrypted rc4 key
    en_rc4_key = efile.read(32)

    # RC4 encrypted file contents
    buf = efile.read()

    efile.close()

    # Import RSA key
    privkey = RSA.importKey(keyfile.read())
    keyfile.close()

    # RSA using PKCS#1 v1.5 padding
    cipher = PKCS1_v1_5.new(privkey)
    rc4_key = cipher.decrypt(en_rc4_key, '')

    arc4 = ARC4.new(rc4_key)
    open(dfile, 'wb').write(arc4.decrypt(buf))


if __name__ == '__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument('efile', help='The encrypted file', type=argparse.FileType('rb'))
    parser.add_argument('dfile', help='The decrypted file')
    parser.add_argument('keyfile', help='The RSA private key(in PEM or DER format)', type=argparse.FileType('rb'))
    args = parser.parse_args()
    main(args.efile, args.dfile, args.keyfile)